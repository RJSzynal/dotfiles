#!/bin/bash
# Bash wrappers for docker run commands

export JESSFRAZ_DOCKER_REPO_PREFIX=jess
export MY_DOCKER_REPO_PREFIX=rjszynal

#
# Helper Functions
#
generate_docker_args(){
	local display_ip=
	local audio_ip=
	docker_args=(
		-v /etc/localtime:/etc/localtime:ro
	)
	if [ -z ${container_hostname} ]; then
		container_hostname="${container_name}"
	fi
	case ${network} in
		none) ;;
		host)
			display_ip="127.0.0.1"
			audio_ip="127.0.0.1"
			container_ip="127.0.0.1"
			container_hostname="$(hostname)"
			;;
		bridge)
			relies_on_networks ${extra_networks[@]};
			display_ip=$(docker network inspect --format='{{range .IPAM.Config}}{{.Gateway}}{{end}}' ${network})
			audio_ip=$(docker network inspect --format='{{range .IPAM.Config}}{{.Gateway}}{{end}}' ${network})
			common_docker_args+=(
				--hostname ${container_hostname}
			)
			;;
		secure)
			relies_on pia-vpn
			network="container:pia-vpn"
			display_ip=$(docker network inspect --format='{{range .IPAM.Config}}{{.Gateway}}{{end}}' untrusted)
			audio_ip=$(docker network inspect --format='{{range .IPAM.Config}}{{.Gateway}}{{end}}' untrusted)
			set_container_hostname pia-vpn
			set_container_ip untrusted pia-vpn
			;;
		torproxy)
			relies_on torproxy
			network="container:torproxy"
			display_ip=$(docker network inspect --format='{{range .IPAM.Config}}{{.Gateway}}{{end}}' untrusted)
			audio_ip=$(docker network inspect --format='{{range .IPAM.Config}}{{.Gateway}}{{end}}' untrusted)
			set_container_hostname torproxy
			set_container_ip untrusted torproxy
			;;
		*)
			relies_on_networks ${network} ${extra_networks[@]}
			display_ip=$(docker network inspect --format='{{range .IPAM.Config}}{{.Gateway}}{{end}}' ${network})
			audio_ip=$(docker network inspect --format='{{range .IPAM.Config}}{{.Gateway}}{{end}}' ${network})
			common_docker_args+=(
				--hostname ${container_hostname}
			)
			;;
	esac

	docker_args+=(
		--network ${network}
	)
	if ${use_host_video}; then
		echo "use_host_video: ${use_host_video}"
		docker_args+=(
			-e GDK_SCALE
			-e GDK_DPI_SCALE
			-e QT_DEVICE_PIXEL_RATIO
			-v "${HOME}/.gtkrc:${container_home}/.gtkrc:ro"
			--group-add video
			# -e XAUTHORITY=${container_home}/.Xauthority
			# -v "${HOME}/.Xauthority:${container_home}/.Xauthority"
			# -v /usr/share/X11:/usr/share/X11:ro
		)
		if ${use_x11_socket}; then
			echo "use_x11_socket: ${use_x11_socket}"
			docker_args+=(
				-e DISPLAY
				-v /tmp/.X11-unix:/tmp/.X11-unix
			)
			# Add container to xhost allowed list for 5 seconds (not needed?)
			# if [ -n "${container_hostname}" ]; then
			# 	xhost +local:${container_hostname}
			# 	echo xhost +local:${container_hostname}
			# 	(sleep 5; xhost -local:${container_hostname}) &
			# else
			# 	echo "Error: Container hostname not set"
			# fi
		else
			docker_args+=(
				-e DISPLAY="${display_ip}${DISPLAY}"
			)
		fi
	fi
	if ${use_host_audio}; then
		echo "use_host_audio: ${use_host_audio}"
		docker_args+=(
			-e PULSE_SERVER=${audio_ip}
			--device /dev/snd
			--group-add audio
		)
	fi
	if ${use_host_dbus}; then
		echo "use_host_dbus: ${use_host_dbus}"
		use_host_user=true
		docker_args+=(
			-e DBUS_SESSION_BUS_ADDRESS
			-v "/run/user/$(id -u):/run/user/$(id -u)"
		)
	fi
	if ${use_host_user}; then
		echo "use_host_user: ${use_host_user}"
		docker_args+=(
			-u $(id -u):$(id -g)
			-v /etc/passwd:/etc/passwd:ro
			-v /etc/group:/etc/group:ro
			-e HOME=${HOME}
			-w "${HOME}"
		)
	fi
	docker_args+=( ${extra_docker_args[@]} )
}
docker_run(){
	use_host_video=${use_host_video:-false}
	use_x11_socket=${use_x11_socket:-true}
	use_host_audio=${use_host_audio:-false}
	use_host_dbus=${use_host_dbus:-false}
	use_host_user=${use_host_user:-false}
	attach_tty=${attach_tty:-false}
	generate_docker_args
	del_stopped ${container_name}

	local docker_create_tty=
	local docker_start_tty=
	if ${attach_tty}; then
		docker_create_tty=" -it"
		docker_start_tty=" -i"
	fi

	docker create --rm${docker_tty} \
		${docker_args[@]} \
		--name ${container_name} \
		${image_name} \
		${application_args[@]} 2>/dev/null

	for net in "${extra_networks[@]}"; do
		docker network connect ${net} ${container_name}
	done

	docker start${docker_start_tty} ${container_name}

# I'm just banking on this happening fast enough to beat the container's first attempt to connect to the x server
	if [ -z "${container_ip}" ]; then
		set_container_ip ${network} ${container_name}
	fi
	if ${use_host_video}; then
		if ! ${use_x11_socket}; then
			if [ -n "${container_ip}" ]; then
				xhost +${container_ip}
				(sleep 5; xhost -${container_ip}) &
			else
				echo "Error: Container IP not set"
			fi
		fi
	fi
}
del_stopped(){
	local name=$1
	local force=${2:-false}
	local exists=$(docker ps -a --format "{{.Names}}" --filter "name=${name}" | wc -l)

	if [ ${exists} -eq 1 ]; then
		local state=$(docker inspect --format "{{.State.Running}}" "${name}" 2>/dev/null)
		if ! ${state}; then
			docker rm "${name}" 2>/dev/null
		elif ${force}; then
			docker rm -f "${name}" 2>/dev/null
		else
			echo "${name} is already running"
		fi
	fi
}
set_container_ip(){
	local container_network_format="{{.NetworkSettings.Networks.${1}.IPAddress}}"
	container_ip=$(docker inspect --format ${container_network_format} ${2} 2>/dev/null)
}
set_container_hostname(){
	local container_hostname_format="{{.Config.Hostname}}"
	container_hostname=$(docker inspect --format ${container_hostname_format} ${1} 2>/dev/null)
}
rmctr(){
	# shellcheck disable=SC2068
	docker rm -f $@ 2>/dev/null || true
}
relies_on(){
	for container in "$@"; do
		local state=$(docker inspect --format "{{.State.Running}}" "${container}" 2>/dev/null)

		if [[ "${state}" == "false" ]] || [[ "${state}" == "" ]]; then
			echo "${container} is not running, starting it for you."
			${container}
		fi
	done
}
relies_on_networks(){
	for network in "$@"; do
		docker network create "${network}" 2>/dev/null || true
	done
}
# creates an nginx config for a local route
nginx_config(){
	server=$1
	route=$2

	cat >"${HOME}/.nginx/conf.d/${server}.conf" <<-EOF
	upstream ${server} { server ${route}; }
	server {
	server_name ${server};

	location / {
	proxy_pass  http://${server};
	proxy_http_version 1.1;
	proxy_set_header Upgrade \$http_upgrade;
	proxy_set_header Connection "upgrade";
	proxy_set_header Host \$http_host;
	proxy_set_header X-Forwarded-Proto \$scheme;
	proxy_set_header X-Forwarded-For \$remote_addr;
	proxy_set_header X-Forwarded-Port \$server_port;
	proxy_set_header X-Request-Start \$msec;
}
	}
	EOF

	# restart nginx
	docker restart nginx

	# add host to /etc/hosts
	hostess add "$server" 127.0.0.1

	# open browser
	browser-exec "http://${server}"
}
alias browser-exec=browser_exec
browser_exec(){
	xdg-open ${@}
}
function is_valid_ip(){
	# Thanks Mitch Frazier https://www.linuxjournal.com/content/validating-ip-address-bash-script
    local  ip=$1
    local  stat=1

    if [[ $ip =~ ^[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}$ ]]; then
        OIFS=$IFS
        IFS='.'
        ip=($ip)
        IFS=$OIFS
        [[ ${ip[0]} -le 255 && ${ip[1]} -le 255 \
            && ${ip[2]} -le 255 && ${ip[3]} -le 255 ]]
        stat=$?
    fi
    return $stat
}

#
# Container Aliases
#
alias apt-file="apt_file"
apt_file(){
	local container_name="apt-file"
	local container_home="/root"
	local image_name="${JESSFRAZ_DOCKER_REPO_PREFIX}/apt-file"
	local use_host_video=false
	local use_host_audio=false
	local use_host_dbus=false
	local use_host_user=false
	local attach_tty=true
	local network="trusted"
	local extra_networks=()
	local container_ip
	local container_hostname
	local extra_docker_args=()
	local application_args=(
		apt-file
		"$@"
	)

	docker_run
}
audacity(){
	local container_name="audacity"
	local container_home="/root"
	local image_name="${JESSFRAZ_DOCKER_REPO_PREFIX}/audacity"
	local use_host_video=true
	local use_host_audio=true
	local use_host_dbus=false
	local use_host_user=false
	local attach_tty=false
	local network="trusted"
	local extra_networks=()
	local container_ip
	local container_hostname
	local extra_docker_args=()
	local application_args=(
		"$@"
	)

	docker_run
}
aws(){
	local container_name="aws"
	local container_home="/root"
	local image_name="${JESSFRAZ_DOCKER_REPO_PREFIX}/awscli"
	local use_host_video=false
	local use_host_audio=false
	local use_host_dbus=false
	local use_host_user=false
	local attach_tty=true
	local network="trusted"
	local extra_networks=()
	local container_ip
	local container_hostname
	local extra_docker_args=(
		-v "${HOME}/.aws:${container_home}/.aws"
		-e AWS_DEFAULT_REGION
		-e AMAZON_ACCESS_KEY_ID
		-e AMAZON_SECRET_ACCESS_KEY
	)
	local application_args=(
		"$@"
	)

	docker_run
}
az(){
	local container_name="az"
	local container_home="/root"
	local image_name="${JESSFRAZ_DOCKER_REPO_PREFIX}/azure-cli"
	local use_host_video=false
	local use_host_audio=false
	local use_host_dbus=false
	local use_host_user=false
	local attach_tty=true
	local network="trusted"
	local extra_networks=()
	local container_ip
	local container_hostname
	local extra_docker_args=(
		-v "${HOME}/.azure:${container_home}/.azure"
		--log-driver none
	)
	local application_args=(
		"$@"
	)

	docker_run
}
bees(){
	local container_name="bees"
	local container_home="/root"
	local image_name="${JESSFRAZ_DOCKER_REPO_PREFIX}/beeswithmachineguns"
	local use_host_video=false
	local use_host_audio=false
	local use_host_dbus=false
	local use_host_user=false
	local attach_tty=true
	local network="trusted"
	local extra_networks=()
	local container_ip
	local container_hostname
	local extra_docker_args=(
		-e NOTARY_TOKEN
		-v "${HOME}/.bees:${container_home}/.bees"
		-v "${HOME}/.boto:${container_home}/.boto"
		-v "${HOME}/.dev:${container_home}/.ssh:ro"
		--log-driver none
	)
	local application_args=(
		"$@"
	)

	docker_run
}
cadvisor(){
	local container_name="cadvisor"
	local container_home="/root"
	local image_name="google/cadvisor"
	local use_host_video=false
	local use_host_audio=false
	local use_host_dbus=false
	local use_host_user=false
	local attach_tty=false
	local network="trusted"
	local extra_networks=()
	local container_ip
	local container_hostname
	local extra_docker_args=(
		--restart always
		-v /:/rootfs:ro
		-v /var/run:/var/run:rw
		-v /sys:/sys:ro
		-v /var/lib/docker/:/var/lib/docker:ro
	)
	local application_args=(
		"$@"
	)

	docker_run
	if is_valid_ip "${container_ip}"; then
		hostess add ${container_name} ${container_ip}
	fi
	browser-exec "http://${container_name}:8080"
}
cheese(){
	local container_name="cheese"
	local container_home="/root"
	local image_name="${JESSFRAZ_DOCKER_REPO_PREFIX}/cheese"
	local use_host_video=true
	local use_host_audio=true
	local use_host_dbus=false
	local use_host_user=false
	local attach_tty=false
	local network="trusted"
	local extra_networks=()
	local container_ip
	local container_hostname
	local extra_docker_args=(
		-v "${HOME}/Pictures:${container_home}/Pictures"
	)
	local application_args=(
		"$@"
	)

	docker_run
}
chrome(){
	local run_type=
	if [[ "$1" == "secure" ]] || [[ "$1" == "tor" ]]; then
		run_type="$1"
		shift
	fi
	local container_name="chrome"
	local container_home="/home/chrome"
	local image_name="${JESSFRAZ_DOCKER_REPO_PREFIX}/chrome"
	local use_host_video=true
	local use_host_audio=true
	local use_host_dbus=false
	local use_host_user=false
	local attach_tty=false
	local network="trusted"
	local extra_networks=()
	local container_ip
	local container_hostname
	local extra_docker_args=(
		--cpuset-cpus 0
		--memory 3gb
		--shm-size=2g
		--device /dev/dri
		--device /dev/usb
		--device /dev/bus/usb
		-v "/etc/hosts:/etc/hosts:ro"
		--security-opt seccomp:${HOME}/seccomp/chrome.json
	)
	local application_args=()

	case "${run_type}" in
		secure)
			container_name="${container_name}-secure"
			network="secure"

			extra_docker_args+=(
				--tmpfs "${container_home}/.cache"
				--tmpfs "${container_home}/.config"
				--tmpfs "${container_home}/.pki"
				--tmpfs "${container_home}/.local"
				--tmpfs "${container_home}/.gnome"
			)
			application_args+=(
				--user-data-dir="${container_home}/.config/google-chrome"
				--incognito
				--no-first-run
				--no-default-browser-check
			)

			if [[ "$@" == "" ]]; then
				application_args+=(
					https://www.privateinternetaccess.com/
				)
			fi
			;;
		tor)
			relies_on torproxy
			container_name="${container_name}-tor"
			network="untrusted"

			extra_docker_args+=(
				--tmpfs "${container_home}/.cache"
				--tmpfs "${container_home}/.config"
				--tmpfs "${container_home}/.pki"
				--tmpfs "${container_home}/.local"
				--tmpfs "${container_home}/.gnome"
			)
			application_args+=(
				--user-data-dir="${container_home}/.config/google-chrome"
				--incognito
				--no-first-run
				--no-default-browser-check
				--proxy-server="socks5://torproxy:9050"
				--host-resolver-rules="MAP * ~NOTFOUND , EXCLUDE torproxy"
			)

			if [[ "$@" == "" ]]; then
				application_args+=(
					https://check.torproject.org/api/ip
				)
			fi
			;;
		*)
			container_home="${HOME}"
			extra_docker_args+=(
				-v /etc/passwd:/etc/passwd:ro
				-u $(id -u):$(id -g)
				-v ${HOME}/.chrome/cache:${container_home}/.cache
				-v ${HOME}/.chrome/config:${container_home}/.config
				-v ${HOME}/.chrome/pki:${container_home}/.pki
				-v ${HOME}/.chrome/local:${container_home}/.local
				-v ${HOME}/.chrome/gnome:${container_home}/.gnome
				-v ${HOME}/Downloads:${container_home}/Downloads
				-v ${HOME}/Pictures:${container_home}/Pictures
				-v ${HOME}/Torrents:${container_home}/Torrents
			)
			application_args+=(
				--user-data-dir="${HOME}/.config/google-chrome"
			)
			;;
	esac
	local args_hash=$(sha1sum <<<"${*}" | cut -c1-40)
	container_name="${container_name}-${args_hash}"
	unset args
	application_args+=(
		"$@"
	)

	if [ ! -f ${HOME}/seccomp/chrome.json ]; then
		mkdir -p ${HOME}/seccomp
		wget https://raw.githubusercontent.com/jfrazelle/dotfiles/master/etc/docker/seccomp/chrome.json -O ${HOME}/seccomp/chrome.json
	fi

	docker_run
}
consul(){
	local container_name="consul"
	local container_home="/root"
	local image_name="consul"
	local use_host_video=false
	local use_host_audio=false
	local use_host_dbus=false
	local use_host_user=false
	local attach_tty=false
	local network="trusted"
	local extra_networks=()
	local container_ip
	local container_hostname
	local encrypt_key="$(docker run --rm ${image_name} keygen)"
	local extra_docker_args=(
		-v "${HOME}/.consul:/consul/config"
		-v /var/run/docker.sock:/var/run/docker.sock:ro
		-e GOMAXPROCS=2
		--restart always
	)
	local application_args=(
		agent
		-bootstrap-expect 1
		-encrypt "${encrypt_key}"
		-ui
		-server
		-datacenter szynal
		-bind 0.0.0.0
		-client 0.0.0.0
		"$@"
	)
	# check if we passed args and if consul is running
	local state=$(docker inspect --format "{{.State.Running}}" ${container_name} 2>/dev/null)
	if [[ "${state}" == "true" ]] && [[ "$*" != "" ]]; then
		docker exec -it ${container_name} consul "$@"
		return 0
	fi

	docker_run
	if is_valid_ip "${container_ip}"; then
		hostess add ${container_name} ${container_ip}
	fi
	browser-exec "http://${container_name}:8500"
}
dcos(){
	local container_name="dcos"
	local container_home="/root"
	local image_name="${JESSFRAZ_DOCKER_REPO_PREFIX}/dcos-cli"
	local use_host_video=false
	local use_host_audio=false
	local use_host_dbus=false
	local use_host_user=false
	local attach_tty=true
	local network="trusted"
	local extra_networks=()
	local container_ip
	local container_hostname
	local extra_docker_args=(
		-v "${HOME}/.dcos:${container_home}/.dcos"
		-v "$(pwd):${container_home}/apps"
		-w ${container_home}/apps
	)
	local application_args=(
		"$@"
	)

	docker_run
}
firefox-browser(){
	local run_type=
	if [[ "$1" == "secure" ]]; then
		run_type="$1"
		shift
	fi
	local container_name="firefox"
	local container_home="/home/firefox"
	local image_name="${MY_DOCKER_REPO_PREFIX}/firefox"
	local use_host_video=true
	local use_host_audio=true
	local use_host_dbus=false
	local use_host_user=false
	local attach_tty=false
	local network="trusted"
	local extra_networks=()
	local container_ip
	local container_hostname
	local extra_docker_args=(
		--cpuset-cpus 0
		--memory 3gb
		--shm-size=2g
		--device /dev/dri
		--device /dev/usb
		--device /dev/bus/usb
		-v "/etc/hosts:/etc/hosts:ro"
	)
	local application_args=()

	case "${run_type}" in
		secure)
			container_name="${container_name}-secure"
			network="secure"

			extra_docker_args+=(
				--tmpfs "${container_home}/.cache"
				--tmpfs "${container_home}/.mozilla"
			)
			application_args+=(
				-private-window
			)

			if [[ "$@" == "" ]]; then
				application_args+=(
					https://www.privateinternetaccess.com/
			)
			fi
			;;
		*)
			container_home="${HOME}"
			extra_docker_args+=(
				-v /etc/passwd:/etc/passwd:ro
				-u $(id -u):$(id -g)
				-v ${HOME}/.firefox/cache:${container_home}/.cache
				-v ${HOME}/.firefox/mozilla:${container_home}/.mozilla
				-v ${HOME}/Downloads:${container_home}/Downloads
				-v ${HOME}/Pictures:${container_home}/Pictures
				-v ${HOME}/Torrents:${container_home}/Torrents
			)
			application_args+=(
			)
			;;
	esac
	local args_hash=$(sha1sum <<<"${*}" | cut -c1-40)
	container_name="${container_name}-${args_hash}"
	unset args
	application_args+=(
		"$@"
	)

	docker_run
}
fleetctl(){
	local container_name="fleet"
	local container_home="/root"
	local image_name="r.j3ss.co/fleet"
	local use_host_video=false
	local use_host_audio=false
	local use_host_dbus=false
	local use_host_user=false
	local attach_tty=true
	local network="trusted"
	local extra_networks=()
	local container_ip
	local container_hostname
	local extra_docker_args=(
		--entrypoint fleetctl
		-v "${HOME}/.fleet://.fleet"
	)
	local application_args=(
		"$@"
	)

	docker_run
}
gcalcli(){
	local container_name="gcalcli"
	local container_home="/home/gcalcli"
	local image_name="${JESSFRAZ_DOCKER_REPO_PREFIX}/gcalcli"
	local use_host_video=false
	local use_host_audio=false
	local use_host_dbus=false
	local use_host_user=false
	local attach_tty=true
	local network="trusted"
	local extra_networks=()
	local container_ip
	local container_hostname
	local extra_docker_args=(
		-v "${HOME}/.gcalcli/home:${container_home}/home"
		-v "${HOME}/.gcalcli/work/oauth:${container_home}/.gcalcli_oauth"
		-v "${HOME}/.gcalcli/work/gcalclirc:${container_home}/.gcalclirc"
	)
	local application_args=(
		"$@"
	)

	docker_run
}
dgcloud(){
	local container_name="gcloud"
	local container_home="/root"
	local image_name="${JESSFRAZ_DOCKER_REPO_PREFIX}/gcloud"
	local use_host_video=false
	local use_host_audio=false
	local use_host_dbus=false
	local use_host_user=false
	local attach_tty=true
	local network="trusted"
	local extra_networks=()
	local container_ip
	local container_hostname
	local extra_docker_args=(
		-v "${HOME}/.gcloud:${container_home}/.config/gcloud"
		-v "${HOME}/.ssh:${container_home}/.ssh:ro"
		-v "$(command -v docker):/usr/bin/docker"
		-v /var/run/docker.sock:/var/run/docker.sock
	)
	local application_args=(
		"$@"
	)

	docker_run
}
gimp(){
	local container_name="gimp"
	local container_home="/root"
	local image_name="${JESSFRAZ_DOCKER_REPO_PREFIX}/gimp"
	local use_host_video=true
	local use_host_audio=true
	local use_host_dbus=false
	local use_host_user=false
	local attach_tty=false
	local network="trusted"
	local extra_networks=()
	local container_ip
	local container_hostname
	local extra_docker_args=(
		-v "${HOME}/Pictures:${container_home}/Pictures"
	)
	local application_args=(
		"$@"
	)

	docker_run
}
gitsome(){
	local container_name="gitsome"
	local container_home="/home/anon"
	local image_name="${JESSFRAZ_DOCKER_REPO_PREFIX}/gitsome"
	local use_host_video=false
	local use_host_audio=false
	local use_host_dbus=false
	local use_host_user=false
	local attach_tty=true
	local network="trusted"
	local extra_networks=()
	local container_ip
	local container_hostname
	local extra_docker_args=(
		-v "${HOME}/.gitsomeconfig:${container_home}/.gitsomeconfig"
		-v "${HOME}/.gitsomeconfigurl:${container_home}/.gitsomeconfigurl"
	)
	local application_args=(
		"$@"
	)

	docker_run
}
hollywood(){
	local container_name="hollywood"
	local container_home="/root"
	local image_name="${JESSFRAZ_DOCKER_REPO_PREFIX}/hollywood"
	local use_host_video=false
	local use_host_audio=false
	local use_host_dbus=false
	local use_host_user=false
	local attach_tty=true
	local network="trusted"
	local extra_networks=()
	local container_ip
	local container_hostname
	local extra_docker_args=()
	local application_args=(
		"$@"
	)

	docker_run
}
htop(){
	local container_name="htop"
	local container_home="/root"
	local image_name="${JESSFRAZ_DOCKER_REPO_PREFIX}/htop"
	local use_host_video=false
	local use_host_audio=false
	local use_host_dbus=false
	local use_host_user=false
	local attach_tty=true
	local network="none"
	local extra_networks=()
	local container_ip
	local container_hostname
	local extra_docker_args=(
		--pid host
	)
	local application_args=(
		"$@"
	)

	docker_run
}
htpasswd(){
	local container_name="htpasswd"
	local container_home="/root"
	local image_name="${JESSFRAZ_DOCKER_REPO_PREFIX}/htpasswd"
	local use_host_video=false
	local use_host_audio=false
	local use_host_dbus=false
	local use_host_user=false
	local attach_tty=true
	local network="none"
	local extra_networks=()
	local container_ip
	local container_hostname
	local extra_docker_args=(
		--log-driver none
	)
	local application_args=(
		"$@"
	)

	docker_run
}
alias http=httpie
httpie(){
	local container_name="httpie"
	local container_home="/root"
	local image_name="${JESSFRAZ_DOCKER_REPO_PREFIX}/httpie"
	local use_host_video=false
	local use_host_audio=false
	local use_host_dbus=false
	local use_host_user=false
	local attach_tty=true
	local network="trusted"
	local extra_networks=()
	local container_ip
	local container_hostname
	local extra_docker_args=(
		-v /var/run/docker.sock:/var/run/docker.sock
		--log-driver none
	)
	local application_args=(
		"$@"
	)

	docker_run
}
imagemin(){
	local image_path=$(realpath "$1")
	local directory=$(dirname "${image_path}")
	local container_home="/root"
	local image_name=$(basename "${image_path}")
	local use_host_video=false
	local use_host_audio=false
	local use_host_dbus=false
	local use_host_user=false
	local extension="${image_name##*.}"
	local filename="${image_name%.*}"
	local container_name="imagemin"
	local container_home="/root"
	local image_name="${JESSFRAZ_DOCKER_REPO_PREFIX}/imagemin"
	local use_host_video=false
	local use_host_audio=false
	local use_host_dbus=false
	local use_host_user=false
	local attach_tty=true
	local network="trusted"
	local extra_networks=()
	local container_ip
	local container_hostname
	local extra_docker_args=(
		-v "${directory}:${container_home}/Pictures"
	)
	local application_args=(
		sh -c "imagemin ${container_home}/Pictures/${image_name} > ${container_home}/Pictures/${filename}_min.${extension}"
	)

	docker_run
}
irssi() {
	local container_name="irssi"
	local container_home="/home/user"
	local image_name="${JESSFRAZ_DOCKER_REPO_PREFIX}/irssi"
	local use_host_video=false
	local use_host_audio=false
	local use_host_dbus=false
	local use_host_user=false
	local attach_tty=true
	local network="trusted"
	local extra_networks=()
	local container_ip
	local container_hostname
	local extra_docker_args=(
		-v "${HOME}/.irssi:${container_home}/.irssi"
		--read-only
	)
	local application_args=(
		"$@"
	)

	docker_run
}
john(){
	local file=$(realpath "$1")
	local container_name="john"
	local container_home="/root"
	local image_name="${JESSFRAZ_DOCKER_REPO_PREFIX}/john"
	local use_host_video=false
	local use_host_audio=false
	local use_host_dbus=false
	local use_host_user=false
	local attach_tty=true
	local network="trusted"
	local extra_networks=()
	local container_ip
	local container_hostname
	local extra_docker_args=(
		-v "${file}:${container_home}/$(basename "${file}")"
	)
	local application_args=(
		"$@"
	)

	docker_run
}
alias build_kernel=kernel_builder
kernel_builder(){
	local container_name="kernel-builder"
	local container_home="/root"
	local image_name="${JESSFRAZ_DOCKER_REPO_PREFIX}/kernel-builder"
	local use_host_video=false
	local use_host_audio=false
	local use_host_dbus=false
	local use_host_user=false
	local attach_tty=true
	local network="trusted"
	local extra_networks=()
	local container_ip
	local container_hostname
	local extra_docker_args=(
		-v '/usr/src:/usr/src'
		-v '/lib/modules:/lib/modules'
		-v '/boot:/boot'
		--entrypoint 'build_kernel'
	)
	local application_args=(
		"$@"
	)

	docker_run
}
keepassxc(){
	local container_name="keepassxc"
	local container_home="/home/keepassxc"
	local image_name="${MY_DOCKER_REPO_PREFIX}/keepassxc"
	local use_host_video=true
	local use_host_audio=true
	local use_host_dbus=false
	local use_host_user=false
	local attach_tty=false
	local network="trusted"
	local extra_networks=()
	local container_ip
	local container_hostname
	local extra_docker_args=(
		-v '/usr/share/X11/xkb:/usr/share/X11/xkb:ro'
		-v '/etc/machine-id:/etc/machine-id:ro'
		-v "${HOME}/.keepassxc/config:${container_home}/.config"
		-v "${HOME}/.keepassxc/cache:${container_home}/.cache"
		-v "${HOME}/.keepassxc/fontconfig:${container_home}/.fontconfig"
		-v "${HOME}/googledrive-home/backup/keepass:${container_home}/databases"
		-v "${HOME}/.ssh:${container_home}/.ssh:ro"
	)
	local application_args=(
		"$@"
	)

	docker_run
}
kvm(){
	local container_name="kvm"
	local container_home="/root"
	local image_name="${JESSFRAZ_DOCKER_REPO_PREFIX}/kvm"
	local use_host_video=true
	local use_host_audio=true
	local use_host_dbus=false
	local use_host_user=false
	local attach_tty=false
	local network="trusted"
	local extra_networks=()
	local container_ip
	local container_hostname
	local extra_docker_args=(
		-v '/run/libvirt:/var/run/libvirt'
		--privileged
	)
	local application_args=(
		"$@"
	)

	# modprobe the module
	modprobe kvm

	docker_run
}
libreoffice(){
	local container_name="libreoffice"
	local container_home="/root"
	local image_name="${JESSFRAZ_DOCKER_REPO_PREFIX}/libreoffice"
	local use_host_video=true
	local use_host_audio=true
	local use_host_dbus=false
	local use_host_user=false
	local attach_tty=false
	local network="trusted"
	local extra_networks=()
	local container_ip
	local container_hostname
	local extra_docker_args=(
		-v "${HOME}/googledrive-home:${container_home}/googledrive-home"
		-v "${HOME}/Documents:${container_home}/Documents"
	)
	local application_args=(
		"$@"
	)

	docker_run
}
alias lpass=lastpass
lastpass(){
	local container_name="lpass"
	local container_home="/root"
	local image_name="${JESSFRAZ_DOCKER_REPO_PREFIX}/lpass"
	local use_host_video=false
	local use_host_audio=false
	local use_host_dbus=false
	local use_host_user=false
	local attach_tty=true
	local network="trusted"
	local extra_networks=()
	local container_ip
	local container_hostname
	local extra_docker_args=(
		-v "${HOME}/.lpass:${container_home}/.lpass"
	)
	local application_args=(
		"$@"
	)

	docker_run
}
lynx(){
	local container_name="lynx"
	local container_home="/root"
	local image_name="${JESSFRAZ_DOCKER_REPO_PREFIX}/lynx"
	local use_host_video=false
	local use_host_audio=false
	local use_host_dbus=false
	local use_host_user=false
	local attach_tty=true
	local network="trusted"
	local extra_networks=()
	local container_ip
	local container_hostname
	local extra_docker_args=(
	)
	local application_args=(
		"$@"
	)

	docker_run
}
masscan(){
	local container_name="masscan"
	local container_home="/root"
	local image_name="${JESSFRAZ_DOCKER_REPO_PREFIX}/masscan"
	local use_host_video=false
	local use_host_audio=false
	local use_host_dbus=false
	local use_host_user=false
	local attach_tty=true
	local network="trusted"
	local extra_networks=()
	local container_ip
	local container_hostname
	local extra_docker_args=(
	)
	local application_args=(
		"$@"
	)

	docker_run
}
alias mc=midnight_commander
midnight_commander(){
	local container_name="mc"
	local container_home="/root"
	local image_name="${JESSFRAZ_DOCKER_REPO_PREFIX}/mc"
	local use_host_video=false
	local use_host_audio=false
	local use_host_dbus=false
	local use_host_user=false
	local attach_tty=true
	local network="trusted"
	local extra_networks=()
	local container_ip
	local container_hostname
	local extra_docker_args=(
		-v "${PWD}:${PWD}"
		--workdir "${PWD}"
	)
	local application_args=(
		"$@"
	)

	docker_run
}
mpd(){
	local container_name="mpd"
	local container_home="/root"
	local image_name="${JESSFRAZ_DOCKER_REPO_PREFIX}/mpd"
	local use_host_video=false
	local use_host_audio=false
	local use_host_dbus=false
	local use_host_user=false
	local attach_tty=false
	local network="trusted"
	local extra_networks=()
	local container_ip
	local container_hostname
	# adding cap sys_admin so I can use nfs mount
	# the container runs as a unpriviledged user mpd
	local extra_docker_args=(
		--cap-add SYS_ADMIN
		-e MPD_HOST=/var/lib/mpd/socket
		-v /etc/exports:/etc/exports:ro
		-v "${HOME}/.mpd:/var/lib/mpd"
		-v "${HOME}/.mpd.conf:/etc/mpd.conf"
	)
	local application_args=(
		"$@"
	)

	docker_run
}
mutt(){
	local container_name="mutt"
	local container_home="/home/user"
	local image_name="${JESSFRAZ_DOCKER_REPO_PREFIX}/mutt"
	local use_host_video=false
	local use_host_audio=false
	local use_host_dbus=false
	local use_host_user=false
	local attach_tty=false
	local network="trusted"
	local extra_networks=()
	local container_ip
	local container_hostname
	local extra_docker_args=()
	case "${1}" in
		riseup)
			container_name="mutt-${1}"
			extra_docker_args+=(
				-e GMAIL=${MAIL_RISEUP}
				-e GMAIL_NAME=${MAIL_RISEUP_NAME}
				-e GMAIL_PASS=${MAIL_RISEUP_PASS}
				-e GMAIL_FROM=${MAIL_RISEUP_FROM}
				-e GPG_ID
				-e IMAP_SERVER=mail.riseup.net
				-e SMTP_SERVER=mail.riseup.net
				-v "${HOME}/.gnupg:${container_home}/.gnupg:ro"
			)
			shift
			;;
		*)
			extra_docker_args+=(
				-e GMAIL
				-e GMAIL_NAME
				-e GMAIL_PASS
				-e GMAIL_FROM
				-e GPG_ID
				-e IMAP_SERVER
				-e SMTP_SERVER
				-v "${HOME}/.gnupg:${container_home}/.gnupg:ro"
			)
			;;
	esac
	local application_args=(
		"$@"
	)

	docker_run
}
ncmpc(){
	relies_on mpd
	local container_name="ncmpc"
	local container_home="/root"
	local image_name="${JESSFRAZ_DOCKER_REPO_PREFIX}/ncmpc"
	local use_host_video=false
	local use_host_audio=false
	local use_host_dbus=false
	local use_host_user=false
	local attach_tty=true
	local network="trusted"
	local extra_networks=()
	local container_ip
	local container_hostname
	local extra_docker_args=(
		-v "${HOME}/.mpd/socket:/var/run/mpd/socket"
		-e MPD_HOST=/var/run/mpd/socket
	)
	local application_args=(
		"$@"
	)

	docker_run
}
neoman(){
	local container_name="neoman"
	local container_home="/root"
	local image_name="${JESSFRAZ_DOCKER_REPO_PREFIX}/neoman"
	local use_host_video=true
	local use_host_audio=true
	local use_host_dbus=false
	local use_host_user=false
	local attach_tty=false
	local network="trusted"
	local extra_networks=()
	local container_ip
	local container_hostname
	local extra_docker_args=(
		--device /dev/bus/usb
		--device /dev/usb
	)
	local application_args=(
		"$@"
	)

	docker_run
}
nes(){
	local game=$1
	shift
	local container_name="nes"
	local container_home="/root"
	local image_name="${JESSFRAZ_DOCKER_REPO_PREFIX}/nes"
	local use_host_video=true
	local use_host_audio=true
	local use_host_dbus=false
	local use_host_user=false
	local attach_tty=false
	local network="trusted"
	local extra_networks=()
	local container_ip
	local container_hostname
	local extra_docker_args=(
	)
	local application_args=(
		"/games/${game}.rom" "$@"
	)

	docker_run
}
alias nc=netcat
netcat(){
	local container_name="netcat"
	local container_home="/root"
	local image_name="${JESSFRAZ_DOCKER_REPO_PREFIX}/netcat"
	local use_host_video=false
	local use_host_audio=false
	local use_host_dbus=false
	local use_host_user=false
	local attach_tty=true
	local network="host"
	local extra_networks=()
	local container_ip
	local container_hostname
	local extra_docker_args=(
	)
	local application_args=(
		"$@"
	)

	docker_run
}
nginx(){
	local container_name="nginx-${1}"
	local container_home="/root"
	local image_name="${JESSFRAZ_DOCKER_REPO_PREFIX}/nginx"
	local use_host_video=false
	local use_host_audio=false
	local use_host_dbus=false
	local use_host_user=false
	local attach_tty=false
	local network="trusted"
	local extra_networks=()
	local container_ip
	local container_hostname
	local extra_docker_args=(
		-v "${HOME}/.nginx:/etc/nginx:ro"
		-v "${2}:/usr/share/nginx/html:ro"
	)
	local application_args=(
	)

	docker_run
	if is_valid_ip "${container_ip}"; then
		hostess add ${1} ${container_ip}
	fi
}
nmap(){
	local container_name="nmap"
	local container_home="/root"
	local image_name="${JESSFRAZ_DOCKER_REPO_PREFIX}/nmap"
	local use_host_video=false
	local use_host_audio=false
	local use_host_dbus=false
	local use_host_user=false
	local attach_tty=true
	local network="host"
	local extra_networks=()
	local container_ip
	local container_hostname
	local extra_docker_args=(
	)
	local application_args=(
		"$@"
	)

	docker_run
}
notify_osd(){
	local container_name="notify_osd"
	local container_home="/root"
	local image_name="${JESSFRAZ_DOCKER_REPO_PREFIX}/notify-osd"
	local use_host_video=false
	local use_host_audio=false
	local use_host_dbus=false
	local use_host_user=false
	local attach_tty=false
	local network="trusted"
	local extra_networks=()
	local container_ip
	local container_hostname
	local extra_docker_args=(
	)
	local application_args=(
		"$@"
	)

	docker_run
}
alias notify-send=notify_send
notify_send(){
	relies_on notify_osd
	local args=${*:2}
	docker exec -i notify_osd notify-send "$1" "${args}"
}
now(){
	local container_name="now"
	local container_home="/root"
	local image_name="${JESSFRAZ_DOCKER_REPO_PREFIX}/now"
	local use_host_video=false
	local use_host_audio=false
	local use_host_dbus=false
	local use_host_user=false
	local attach_tty=true
	local network="trusted"
	local extra_networks=()
	local container_ip
	local container_hostname
	local extra_docker_args=(
		-v "${HOME}/.now:${container_home}/.now"
		-v "${PWD}:/usr/src/repo:ro"
		--workdir /usr/src/repo
		--log-driver none
	)
	local application_args=(
		"$@"
	)

	docker_run
}
opensnitch(){
	relies_on opensnitchd
	local container_name="opensnitch"
	local container_home="${HOME}"
	local image_name="${JESSFRAZ_DOCKER_REPO_PREFIX}/opensnitch"
	local use_host_video=true
	local use_host_audio=true
	local use_host_dbus=false
	local use_host_user=false
	local attach_tty=false
	local network="host"
	local extra_networks=()
	local container_ip
	local container_hostname
	local extra_docker_args=(
		-v /etc/machine-id:/etc/machine-id:ro
		-v /var/run/dbus:/var/run/dbus
		-v /usr/share/dbus-1:/usr/share/dbus-1
		-v "/run/user/$(id -u):/run/user/$(id -u)"
		-e DBUS_SESSION_BUS_ADDRESS
		-v /tmp:/tmp
		-u $(id -u):$(id -g)
		-v /etc/passwd:/etc/passwd:ro
		-v /etc/group:/etc/group:ro
		-e HOME=${container_home}
		-w "${container_home}"
		--security-opt seccomp=unconfined
	)
	local application_args=(
	)

	docker_run
}
opensnitch-old(){
	docker run --rm -it \
		-v /etc/localtime:/etc/localtime:ro \
		-e DISPLAY \
		-v /usr/share/X11:/usr/share/X11:ro \
		-v /usr/share/dbus-1:/usr/share/dbus-1 \
		-v /etc/machine-id:/etc/machine-id:ro \
		-v /var/run/dbus:/var/run/dbus \
		-v "/run/user/$(id -u):/run/user/$(id -u)" \
		-e DBUS_SESSION_BUS_ADDRESS \
		-e XAUTHORITY \
		-v "${HOME}/.Xauthority:${HOME}/.Xauthority" \
		-e HOME \
		-e QT_DEVICE_PIXEL_RATIO \
		-e XDG_RUNTIME_DIR \
		-v /etc/passwd:/etc/passwd:ro \
		-v /etc/group:/etc/group:ro \
		-v /tmp:/tmp \
		-u "$(id -u)" -w "${HOME}" \
		--network host \
		--name opensnitch \
		${JESSFRAZ_DOCKER_REPO_PREFIX}/opensnitch
}
opensnitchd(){
	local container_name="opensnitchd"
	local container_home="/root"
	local image_name="${JESSFRAZ_DOCKER_REPO_PREFIX}/opensnitchd"
	local use_host_video=false
	local use_host_audio=false
	local use_host_dbus=false
	local use_host_user=false
	local attach_tty=false
	local network="host"
	local extra_networks=()
	local container_ip
	local container_hostname
	local extra_docker_args=(
		--cap-add NET_ADMIN
		-v /etc/machine-id:/etc/machine-id:ro
		-v /var/run/dbus:/var/run/dbus
		-v /usr/share/dbus-1:/usr/share/dbus-1
		-v "/var/run/user/$(id -u):/var/run/user/$(id -u)"
		-e DBUS_SESSION_BUS_ADDRESS
		-v /tmp:/tmp
	)
	local application_args=(
		"$@"
	)

	docker_run
}
osquery(){
	local container_name="osquery"
	local container_home="/root"
	local image_name="${JESSFRAZ_DOCKER_REPO_PREFIX}/osquery"
	local use_host_video=false
	local use_host_audio=false
	local use_host_dbus=false
	local use_host_user=false
	local attach_tty=false
	local network="host"
	local extra_networks=()
	local container_ip
	local container_hostname
	local extra_docker_args=(
		-v /var/run/docker.sock:/var/run/docker.sock
		-v /etc/os-release:/etc/os-release:ro
		--ipc host
		--pid host
		-e OSQUERY_ENROLL_SECRET
		--privileged
	)
	local application_args=(
		--verbose
		--enroll_secret_env=OSQUERY_ENROLL_SECRET
		--docker_socket=/var/run/docker.sock
		--host_identifier=hostname
		--tls_hostname="${OSQUERY_DOMAIN}"
		--enroll_tls_endpoint=/api/v1/osquery/enroll
		--config_plugin=tls
		--config_tls_endpoint=/api/v1/osquery/config
		--config_tls_refresh=10
		--disable_distributed=false
		--distributed_plugin=tls
		--distributed_interval=10
		--distributed_tls_max_attempts=3
		--distributed_tls_read_endpoint=/api/v1/osquery/distributed/read
		--distributed_tls_write_endpoint=/api/v1/osquery/distributed/write
		--logger_plugin=tls
		--logger_tls_endpoint=/api/v1/osquery/log
		--logger_tls_period=10
		"$@"
	)

	docker_run
}
pandoc(){
	local file=${*: -1}
	local lfile
	lfile=$(readlink -m "$(pwd)/${file}")
	local rfile
	rfile=$(readlink -m "/$(basename "${file}")")
	local args=${*:1:${#@}-1}

	local container_name="pandoc"
	local container_home="/root"
	local image_name="${JESSFRAZ_DOCKER_REPO_PREFIX}/pandoc"
	local use_host_video=false
	local use_host_audio=false
	local use_host_dbus=false
	local use_host_user=false
	local attach_tty=true
	local network="trusted"
	local extra_networks=()
	local container_ip
	local container_hostname
	local extra_docker_args=(
		-v "${lfile}:${rfile}"
		--tmpfs /tmp
	)
	local application_args=(
		"${args}"
		"${rfile}"
	)

	docker_run
}
pivman(){
	local container_name="pivman"
	local container_home="/root"
	local image_name="${JESSFRAZ_DOCKER_REPO_PREFIX}/pivman"
	local use_host_video=true
	local use_host_audio=true
	local use_host_dbus=false
	local use_host_user=false
	local attach_tty=false
	local network="trusted"
	local extra_networks=()
	local container_ip
	local container_hostname
	local extra_docker_args=(
		--device /dev/bus/usb
		--device /dev/usb
	)
	local application_args=(
		"$@"
	)

	docker_run
}
pms(){
	relies_on mpd
	local container_name="pms"
	local container_home="/root"
	local image_name="${JESSFRAZ_DOCKER_REPO_PREFIX}/pms"
	local use_host_video=false
	local use_host_audio=false
	local use_host_dbus=false
	local use_host_user=false
	local attach_tty=true
	local network="trusted"
	local extra_networks=()
	local container_ip
	local container_hostname
	local extra_docker_args=(
		-v "${HOME}/.mpd/socket:/var/run/mpd/socket" \
		-e MPD_HOST=/var/run/mpd/socket \
	)
	local application_args=(
		"$@"
	)

	docker_run
}
pond(){
	local container_name="pond"
	local container_home="/root"
	local image_name="${JESSFRAZ_DOCKER_REPO_PREFIX}/pond"
	local use_host_video=false
	local use_host_audio=false
	local use_host_dbus=false
	local use_host_user=false
	local attach_tty=true
	local network="torproxy"
	local extra_networks=()
	local container_ip
	local container_hostname
	local extra_docker_args=(
	)
	local application_args=(
		"$@"
	)

	docker_run
}
privoxy(){
	relies_on torproxy
	local container_name="privoxy"
	local container_home="/root"
	local image_name="${JESSFRAZ_DOCKER_REPO_PREFIX}/privoxy"
	local use_host_video=false
	local use_host_audio=false
	local use_host_dbus=false
	local use_host_user=false
	local attach_tty=false
	local network="untrusted"
	local extra_networks=()
	local container_ip
	local container_hostname
	local extra_docker_args=(
	)
	local application_args=(
		"$@"
	)

	docker_run

	if is_valid_ip "${container_ip}"; then
		hostess add ${container_name} ${container_ip}
	fi
}
pulseaudio(){
	local container_name="pulseaudio"
	local container_home="/root"
	local image_name="${JESSFRAZ_DOCKER_REPO_PREFIX}/pulseaudio"
	local use_host_video=false
	local use_host_audio=false
	local use_host_dbus=false
	local use_host_user=false
	local attach_tty=false
	local network="trusted"
	local extra_networks=(
		untrusted
	)
	local container_ip
	local container_hostname
	local extra_docker_args=(
		--restart always
	)
	local application_args=(
		"$@"
	)

	docker_run

	if is_valid_ip "${container_ip}"; then
		hostess add ${container_name} ${container_ip}
	fi
	export PULSE_SERVER=${container_name}
}
rainbowstream(){
	local container_name="rainbowstream"
	local container_home="/root"
	local image_name="${JESSFRAZ_DOCKER_REPO_PREFIX}/rainbowstream"
	local use_host_video=false
	local use_host_audio=false
	local use_host_dbus=false
	local use_host_user=false
	local attach_tty=true
	local network="trusted"
	local extra_networks=()
	local container_ip
	local container_hostname
	local extra_docker_args=(
		-v "${HOME}/.rainbowstream:/root"
	)
	local application_args=(
		"$@"
	)

	docker_run
}
registrator(){
	del_stopped registrator

	docker run -d \
		--restart always \
		-v /var/run/docker.sock:/tmp/docker.sock \
		--network host \
		--name registrator \
		gliderlabs/registrator consul:
}
remmina(){
	del_stopped remmina

	docker run --rm -d \
		-v /etc/localtime:/etc/localtime:ro \
		-e DISPLAY \
		-e GDK_SCALE \
		-e GDK_DPI_SCALE \
		-v "${HOME}/.remmina:/root/.remmina" \
		--name remmina \
		--network host \
		${JESSFRAZ_DOCKER_REPO_PREFIX}/remmina
}
ricochet(){
	del_stopped ricochet

	docker run --rm -d \
		-v /etc/localtime:/etc/localtime:ro \
		-e DISPLAY \
		-e GDK_SCALE \
		-e GDK_DPI_SCALE \
		-e QT_DEVICE_PIXEL_RATIO \
		--device /dev/dri \
		--name ricochet \
		${JESSFRAZ_DOCKER_REPO_PREFIX}/ricochet
}
rstudio(){
	del_stopped rstudio

	docker run --rm -d \
		-v /etc/localtime:/etc/localtime:ro \
		-v "${HOME}/fastly-logs:/root/fastly-logs" \
		-v /dev/shm:/dev/shm \
		-e DISPLAY \
		-e QT_DEVICE_PIXEL_RATIO \
		--device /dev/dri \
		--name rstudio \
		${JESSFRAZ_DOCKER_REPO_PREFIX}/rstudio
}
s3cmdocker(){
	del_stopped s3cmd

	docker run --rm -it \
		-e AWS_ACCESS_KEY="${DOCKER_AWS_ACCESS_KEY}" \
		-e AWS_SECRET_KEY="${DOCKER_AWS_ACCESS_SECRET}" \
		-v "$(pwd):/root/s3cmd-workspace" \
		--name s3cmd \
		${JESSFRAZ_DOCKER_REPO_PREFIX}/s3cmd "$@"
}
scudcloud(){
	del_stopped scudcloud

	docker run --rm -d \
		-v /etc/localtime:/etc/localtime:ro \
		-v /etc/machine-id:/etc/machine-id:ro \
		-v /var/run/dbus:/var/run/dbus \
		-v "/var/run/user/$(id -u):/var/run/user/$(id -u)" \
		-e TERM \
		-e DISPLAY \
		-e XAUTHORITY \
		-e QT_DEVICE_PIXEL_RATIO \
		-e DBUS_SESSION_BUS_ADDRESS \
		-e HOME \
		-v /etc/passwd:/etc/passwd:ro \
		-v /etc/group:/etc/group:ro \
		-u "$(whoami)" -w "${HOME}" \
		-v "${HOME}/.Xauthority:${HOME}/.Xauthority" \
		-v "${HOME}/.scudcloud:${HOME}/.config/scudcloud" \
		--device /dev/snd \
		--name scudcloud \
		${JESSFRAZ_DOCKER_REPO_PREFIX}/scudcloud

	# exit current shell
	# exit 0
}
shorewall(){
	del_stopped shorewall

	docker run --rm -it \
		--network host \
		--cap-add NET_ADMIN \
		--privileged \
		--name shorewall \
		${JESSFRAZ_DOCKER_REPO_PREFIX}/shorewall "$@"
}
skype(){
	del_stopped skype
	relies_on pulseaudio

	docker run --rm -d \
		-v /etc/localtime:/etc/localtime:ro \
		-e DISPLAY \
		--group-add video \
		--group-add audio \
		--network trusted \
		-e PULSE_SERVER=pulseaudio \
		--security-opt seccomp:unconfined \
		--name skype \
		${JESSFRAZ_DOCKER_REPO_PREFIX}/skype
}
slack(){
	del_stopped slack

	docker run -d \
		-v /etc/localtime:/etc/localtime:ro \
		-e DISPLAY \
		--group-add video \
		--group-add audio \
		--network trusted \
		-e PULSE_SERVER=pulseaudio \
		-v "${HOME}/.slack:/root/.config/Slack" \
		--ipc="host" \
		--name slack \
		${JESSFRAZ_DOCKER_REPO_PREFIX}/slack "$@"
}
spotify(){
	del_stopped spotify
	relies_on pulseaudio

	docker run --rm -d \
		--network trusted \
		-v /etc/localtime:/etc/localtime:ro \
		-e DISPLAY \
		-e QT_DEVICE_PIXEL_RATIO \
		--security-opt seccomp:unconfined \
		--group-add video \
		--group-add audio \
		-e PULSE_SERVER=pulseaudio \
		-v ${HOME}/.config/spotify:/home/spotify/.config/spotify \
		-v ${HOME}/.cache/spotify:/home/spotify/spotify \
		--name spotify \
		${JESSFRAZ_DOCKER_REPO_PREFIX}/spotify
}
ssh2john(){
	local file
	file=$(realpath "$1")

	docker run --rm -it \
		-v "${file}:/root/$(basename "${file}")" \
		--entrypoint ssh2john \
		${JESSFRAZ_DOCKER_REPO_PREFIX}/john "$@"
}
sshb0t(){
	del_stopped sshb0t

	if [[ ! -d "${HOME}/.ssh" ]]; then
		mkdir -p "${HOME}/.ssh"
	fi

	if [[ ! -f "${HOME}/.ssh/authorized_keys" ]]; then
		touch "${HOME}/.ssh/authorized_keys"
	fi

	GITHUB_USER=${GITHUB_USER:=rjszynal}

	docker run --rm -it \
		--name sshb0t \
		-v "${HOME}/.ssh/authorized_keys:/root/.ssh/authorized_keys" \
		r.j3ss.co/sshb0t \
		--user "${GITHUB_USER}" --keyfile /root/.ssh/authorized_keys --once
}
steam(){
	del_stopped steam
	relies_on pulseaudio

	docker run --rm -d \
		-v /etc/localtime:/etc/localtime:ro \
		-v /etc/machine-id:/etc/machine-id:ro \
		-v /var/run/dbus:/var/run/dbus \
		-v "${HOME}/.steam:/home/steam" \
		-e DISPLAY \
		--network trusted \
		-e PULSE_SERVER=pulseaudio \
		--device /dev/dri \
		--name steam \
		tianon/steam
}
t(){
	docker run -t --rm \
		-v "${HOME}/.trc:/root/.trc" \
		--log-driver none \
		${JESSFRAZ_DOCKER_REPO_PREFIX}/t "$@"
}
tarsnap(){
	docker run --rm -it \
		-v "${HOME}/.tarsnaprc:/root/.tarsnaprc" \
		-v "${HOME}/.tarsnap:/root/.tarsnap" \
		-v "${HOME}:/root/workdir" \
		${JESSFRAZ_DOCKER_REPO_PREFIX}/tarsnap "$@"
}
telnet(){
	docker run --rm -it \
		--log-driver none \
		${JESSFRAZ_DOCKER_REPO_PREFIX}/telnet "$@"
}
termboy(){
	del_stopped termboy
	local game=$1

	docker run --rm -it \
		--device /dev/snd \
		--name termboy \
		${JESSFRAZ_DOCKER_REPO_PREFIX}/nes "/games/${game}.rom"
}
terraform(){
	docker run --rm -it \
		-v "${HOME}:${HOME}:ro" \
		-v "$(pwd):/usr/src/repo" \
		-v /tmp:/tmp \
		--workdir /usr/src/repo \
		--log-driver none \
		-e GOOGLE_APPLICATION_CREDENTIALS \
		-e SSH_AUTH_SOCK \
		${JESSFRAZ_DOCKER_REPO_PREFIX}/terraform "$@"
}
tor(){
	del_stopped tor

	docker run --rm -d \
		--network host \
		--name tor \
		${JESSFRAZ_DOCKER_REPO_PREFIX}/tor

	# set up the redirect iptables rules
	sudo setup-tor-iptables

	# validate we are running through tor
	browser-exec "https://check.torproject.org/"
}
torbrowser(){
	del_stopped torbrowser

	docker run --rm -d \
		-v /etc/localtime:/etc/localtime:ro \
		-e DISPLAY \
		-e GDK_SCALE \
		-e GDK_DPI_SCALE \
		--device /dev/snd \
		--name torbrowser \
		${JESSFRAZ_DOCKER_REPO_PREFIX}/tor-browser

	# exit current shell
	# exit 0
}
tormessenger(){
	del_stopped tormessenger

	docker run --rm -d \
		-v /etc/localtime:/etc/localtime:ro \
		-e DISPLAY \
		-e GDK_SCALE \
		-e GDK_DPI_SCALE \
		--device /dev/snd \
		--name tormessenger \
		${JESSFRAZ_DOCKER_REPO_PREFIX}/tor-messenger

	# exit current shell
	# exit 0
}
torproxy(){
	local container_name="torproxy"
	local container_home="/root"
	local image_name="${JESSFRAZ_DOCKER_REPO_PREFIX}/tor-proxy"
	local use_host_video=false
	local use_host_audio=false
	local use_host_dbus=false
	local use_host_user=false
	local attach_tty=false
	local network="untrusted"
	local extra_networks=()
	local container_ip
	local container_hostname
	local extra_docker_args=(
	)
	local application_args=(
		"$@"
	)

	docker_run

	if is_valid_ip "${container_ip}"; then
		hostess add ${container_name} ${container_ip}
	fi
}
traceroute(){
	docker run --rm -it \
		--network host \
		${JESSFRAZ_DOCKER_REPO_PREFIX}/traceroute "$@"
}
transmission(){
	del_stopped transmission

	docker run --rm -d \
		-v /etc/localtime:/etc/localtime:ro \
		-v "${HOME}/Torrents:/transmission/download" \
		-v "${HOME}/.transmission:/transmission/config" \
		-p 9091:9091 \
		-p 51413:51413 \
		-p 51413:51413/udp \
		--name transmission \
		${JESSFRAZ_DOCKER_REPO_PREFIX}/transmission


	hostess add transmission "$(docker inspect --format '{{.NetworkSettings.Networks.bridge.IPAddress}}' transmission)"
	browser-exec "http://transmission:9091"
}
travis(){
	docker run --rm -it \
		-v "${HOME}/.travis:/root/.travis" \
		-v "$(pwd):/usr/src/repo:ro" \
		--workdir /usr/src/repo \
		--log-driver none \
		${JESSFRAZ_DOCKER_REPO_PREFIX}/travis "$@"
}
virsh(){
	relies_on kvm

	docker run --rm -it \
		-v /etc/localtime:/etc/localtime:ro \
		-v /run/libvirt:/var/run/libvirt \
		--log-driver none \
		--network container:kvm \
		${JESSFRAZ_DOCKER_REPO_PREFIX}/libvirt-client "$@"
}
virt_viewer(){
	relies_on kvm

	docker run --rm -it \
		-v /etc/localtime:/etc/localtime:ro \
		-e DISPLAY \
		-v /run/libvirt:/var/run/libvirt \
		-e PULSE_SERVER=pulseaudio \
		--group-add audio \
		--log-driver none \
		--network container:kvm \
		${JESSFRAZ_DOCKER_REPO_PREFIX}/virt-viewer "$@"
}
alias virt-viewer="virt_viewer"
visualstudio(){
	del_stopped visualstudio

	docker run --rm -d \
		-v /etc/localtime:/etc/localtime:ro \
		-e DISPLAY \
		--device /dev/dri \
		--name visualstudio \
		${JESSFRAZ_DOCKER_REPO_PREFIX}/vscode
}
#alias vscode="visualstudio"
vscodium(){
	local args_hash=$(sha1sum <<<"${*}" | cut -c1-40)
	local container_name="vscodium-${args_hash}"
	local container_home="/root"
	local image_name="${MY_DOCKER_REPO_PREFIX}/vscodium"
	local use_host_video=true
	local use_host_audio=true
	local use_host_dbus=false
	local use_host_user=false
	local attach_tty=false
	local network="trusted"
	local extra_networks=()
	local container_ip
	local container_hostname
	local extra_docker_args=(
		-v /etc/passwd:/etc/passwd:ro
		-u $(id -u):$(id -g)
		-v ${HOME}/.ssh:${HOME}/.ssh:ro
		-v ${HOME}/.gitconfig:${HOME}/.gitconfig
		-v ${HOME}/.vscodium/config:${HOME}/.config
		-v ${HOME}/.vscodium/vscode-oss:${HOME}/.vscode-oss
		-v ${HOME}/development:${HOME}/development
		-w "${PWD}"
	)
	local application_args=(
		"$@"
	)

	docker_run
}
vlc(){
	del_stopped vlc
	relies_on pulseaudio

	docker run --rm -d \
		-v /etc/localtime:/etc/localtime:ro \
		-e DISPLAY \
		-e GDK_SCALE \
		-e GDK_DPI_SCALE \
		-e QT_DEVICE_PIXEL_RATIO \
		--group-add video \
		--group-add audio \
		--network trusted \
		-e PULSE_SERVER=pulseaudio \
		-v "${HOME}/Torrents:/home/vlc/Torrents" \
		-v "${HOME}/Videos:/home/vlc/Videos" \
		--device /dev/dri \
		--name vlc \
		${JESSFRAZ_DOCKER_REPO_PREFIX}/vlc
}
watchman(){
	del_stopped watchman

	docker run --rm -d \
		-v /etc/localtime:/etc/localtime:ro \
		-v "${HOME}/Downloads:/root/Downloads" \
		--name watchman \
		${JESSFRAZ_DOCKER_REPO_PREFIX}/watchman --foreground
}
weeslack(){
	del_stopped weeslack

	docker run --rm -it \
		-v /etc/localtime:/etc/localtime:ro \
		-v "${HOME}/.weechat:/home/user/.weechat" \
		--name weeslack \
		${JESSFRAZ_DOCKER_REPO_PREFIX}/wee-slack
}
wg(){
	docker run -i --rm \
		--log-driver none \
		-v /tmp:/tmp \
		--cap-add NET_ADMIN \
		--network host \
		--name wg \
		${JESSFRAZ_DOCKER_REPO_PREFIX}/wg "$@"
}
wireshark(){
	del_stopped wireshark

	docker run --rm -d \
		-v /etc/localtime:/etc/localtime:ro \
		-e DISPLAY \
		--cap-add NET_RAW \
		--cap-add NET_ADMIN \
		--network host \
		--name wireshark \
		${JESSFRAZ_DOCKER_REPO_PREFIX}/wireshark
}
wrk(){
	docker run --rm -it \
		--log-driver none \
		--name wrk \
		${JESSFRAZ_DOCKER_REPO_PREFIX}/wrk "$@"
}
ykman(){
	del_stopped ykpersonalize

	docker run --rm -it \
		-v /etc/localtime:/etc/localtime:ro \
		--device /dev/usb \
		--device /dev/bus/usb \
		--name ykman \
		${JESSFRAZ_DOCKER_REPO_PREFIX}/ykman bash
}
ykpersonalize(){
	del_stopped ykpersonalize

	docker run --rm -it \
		-v /etc/localtime:/etc/localtime:ro \
		--device /dev/usb \
		--device /dev/bus/usb \
		--name ykpersonalize \
		${JESSFRAZ_DOCKER_REPO_PREFIX}/ykpersonalize bash
}
yubico_piv_tool(){
	del_stopped yubico-piv-tool

	docker run --rm -it \
		-v /etc/localtime:/etc/localtime:ro \
		--device /dev/usb \
		--device /dev/bus/usb \
		--name yubico-piv-tool \
		${JESSFRAZ_DOCKER_REPO_PREFIX}/yubico-piv-tool bash
}
alias yubico-piv-tool="yubico_piv_tool"

## Robert's extras
chrome-secure(){
	del_stopped chrome-secure
	del_stopped chrome-vpn

	docker run --rm -d \
		--cap-add=NET_ADMIN \
		--device=/dev/net/tun \
		--dns 209.222.18.222 --dns 209.222.18.218 \
		-e REGION=Switzerland \
		-e "USERNAME=$(head -n 1 ${HOME}/pia/login)" \
		-e "PASSWORD=$(tail -n 1 ${HOME}/pia/login)" \
		--name chrome-vpn \
		colinhebert/pia-openvpn

	if [ ! -f ${HOME}/seccomp/chrome.json ]; then
		mkdir -p ${HOME}/seccomp
		wget https://raw.githubusercontent.com/jfrazelle/dotfiles/master/etc/docker/seccomp/chrome.json -O ${HOME}/seccomp/chrome.json
	fi

	SESSIONXAUTH=${XAUTHORITY:-${HOME}/.Xauthority}
	DOCKER_XAUTH=${SESSIONXAUTH}.docker
	cp --preserve=all ${SESSIONXAUTH} ${DOCKER_XAUTH}
	echo "ffff 0000  $(xauth nlist ${DISPLAY} | cut -d\  -f4-)" | xauth -f ${DOCKER_XAUTH} nmerge -

	xhost +"local:docker@"

	docker run --rm -i \
		--network container:chrome-vpn \
		--cpuset-cpus 0 \
		--memory 1gb \
		-e DISPLAY \
		-v ${DOCKER_XAUTH}:${DOCKER_XAUTH}:ro \
		-e XAUTHORITY=${DOCKER_XAUTH} \
		-v ${HOME}/Downloads:/home/chrome/Downloads \
		--security-opt seccomp:${HOME}/seccomp/chrome.json \
		--device /dev/snd \
		--device /dev/dri \
		--group-add audio \
		--shm-size=2g \
		--name chrome-secure \
		${JESSFRAZ_DOCKER_REPO_PREFIX}/chrome \
			-new-instance \
			--incognito \
			--user-data-dir=/data

	xhost -"local:docker@"

	docker rm -fv chrome-vpn
}
chromium(){
	local run_type=
	if [[ "$1" == "secure" ]] || [[ "$1" == "tor" ]]; then
		run_type="$1"
		shift
	fi
	local container_name="chromium"
	local container_home="/home/chromium"
	local image_name="${JESSFRAZ_DOCKER_REPO_PREFIX}/chromium"
	local use_host_video=true
	local use_host_audio=true
	local use_host_dbus=false
	local use_host_user=false
	local attach_tty=false
	local network="trusted"
	local extra_networks=()
	local container_ip
	local container_hostname
	local extra_docker_args=(
		--cpuset-cpus 0
		--memory 3gb
		--shm-size=2g
		--device /dev/dri
		--device /dev/usb
		--device /dev/bus/usb
		-v "/etc/hosts:/etc/hosts:ro"
		--security-opt seccomp:${HOME}/seccomp/chrome.json
	)
	local application_args=()

	case "${run_type}" in
		secure)
			container_name="${container_name}-secure"
			network="secure"

			extra_docker_args+=(
				--tmpfs "${container_home}/.cache"
				--tmpfs "${container_home}/.config"
				--tmpfs "${container_home}/.pki"
				--tmpfs "${container_home}/.local"
				--tmpfs "${container_home}/.gnome"
			)
			application_args+=(
				--user-data-dir="${container_home}/.config/chromium"
				--incognito
				--no-first-run
				--no-default-browser-check
			)

			if [[ "$@" == "" ]]; then
				application_args+=(
					https://www.privateinternetaccess.com/
				)
			fi
			;;
		tor)
			relies_on torproxy
			container_name="${container_name}-tor"
			network="untrusted"

			extra_docker_args+=(
				--tmpfs "${container_home}/.cache"
				--tmpfs "${container_home}/.config"
				--tmpfs "${container_home}/.pki"
				--tmpfs "${container_home}/.local"
				--tmpfs "${container_home}/.gnome"
			)
			application_args+=(
				--user-data-dir="${container_home}/.config/chromium"
				--incognito
				--no-first-run
				--no-default-browser-check
				--proxy-server="socks5://torproxy:9050"
				--host-resolver-rules="MAP * ~NOTFOUND , EXCLUDE torproxy"
			)

			if [[ "$@" == "" ]]; then
				application_args+=(
					https://check.torproject.org/api/ip
				)
			fi
			;;
		*)
			container_home="${HOME}"
			use_host_user=true
			extra_docker_args+=(
				-v ${HOME}/.chromium/cache:${container_home}/.cache
				-v ${HOME}/.chromium/config:${container_home}/.config
				-v ${HOME}/.chromium/pki:${container_home}/.pki
				-v ${HOME}/.chromium/local:${container_home}/.local
				-v ${HOME}/.chromium/gnome:${container_home}/.gnome
				-v ${HOME}/Downloads:${container_home}/Downloads
				-v ${HOME}/Pictures:${container_home}/Pictures
				-v ${HOME}/Torrents:${container_home}/Torrents
			)
			application_args+=(
				--user-data-dir="${HOME}/.config/chromium"
			)
			;;
	esac
	local args_hash=$(sha1sum <<<"${*}" | cut -c1-40)
	container_name="${container_name}-${args_hash}"
	unset args
	application_args+=(
		"$@"
	)

	if [ ! -f ${HOME}/seccomp/chrome.json ]; then
		mkdir -p ${HOME}/seccomp
		wget https://raw.githubusercontent.com/jfrazelle/dotfiles/master/etc/docker/seccomp/chrome.json -O ${HOME}/seccomp/chrome.json
	fi

	docker_run
}
dive(){
	local container_name="dive"
	local container_home="/root"
	local image_name="wagoodman/dive"
	local use_host_video=false
	local use_host_audio=false
	local use_host_dbus=false
	local use_host_user=false
	local attach_tty=true
	local network="trusted"
	local extra_networks=()
	local container_ip
	local container_hostname
	local extra_docker_args=(
		-v /var/run/docker.sock:/var/run/docker.sock
	)
	local application_args=(
		"$@"
	)

	docker_run
}
hostess(){
	local container_name="hostess"
	local container_home="/root"
	local image_name="ondrejmo/hostess"
	local use_host_video=false
	local use_host_audio=false
	local use_host_dbus=false
	local use_host_user=false
	local attach_tty=true
	local network="trusted"
	local extra_networks=()
	local container_ip
	local container_hostname
	local extra_docker_args=(
		-v /etc/hosts:/tmp/hosts:rw
		-e HOSTESS_PATH=/tmp/hosts
	)
	local application_args=(
		"$@"
	)

	docker_run
}
keepass2(){
	del_stopped keepass2

	local display_ip=$(docker network inspect --format='{{range .IPAM.Config}}{{.Gateway}}{{end}}' trusted)

	docker run --rm -d \
		--network trusted \
		-v /etc/localtime:/etc/localtime:ro \
		-e DISPLAY="${display_ip}${DISPLAY}" \
		-e GDK_SCALE \
		-e GDK_DPI_SCALE \
		-v ${HOME}/.keepass2/plugins:/usr/lib/keepass2/Plugins \
		-v ${HOME}/.keepass2/home:/home/keepass2 \
		-v ${HOME}/googledrive-home/backup/keepass:/home/keepass2/databases \
		-v ${HOME}/.ssh:/home/keepass2/.ssh \
		--name keepass2 \
		${MY_DOCKER_REPO_PREFIX}/keepass2
}
pia-vpn(){
	local region
	local name_prefix=
	local attach_tty=false
	local network="untrusted"
	local extra_networks=()

	case "${1}" in
		host)
			name_prefix="host-"
			network="host"
			region="${2:-Switzerland}"
			;;
		*)
			relies_on_networks untrusted
			region="${1:-Switzerland}"
			;;
	esac

	del_stopped ${name_prefix}pia-vpn

	docker run --rm -d \
		--network ${network} \
		--cap-add=NET_ADMIN \
		--device=/dev/net/tun \
		--dns 209.222.18.222 --dns 209.222.18.218 \
		-e REGION="${region}" \
		-e USERNAME="$(head -n 1 ${HOME}/pia/login)" \
		-e PASSWORD="$(tail -n 1 ${HOME}/pia/login)" \
		--name ${name_prefix}pia-vpn \
		colinhebert/pia-openvpn
}
alias signal=signal-messenger
signal-messenger(){
	local container_name="signal-messenger"
	local container_home="/home/signal"
	local image_name="${MY_DOCKER_REPO_PREFIX}/signal-messenger"
	local use_host_video=true
	local use_host_audio=true
	local use_host_dbus=false
	local use_host_user=false
	local attach_tty=false
	local network="trusted"
	local extra_networks=()
	local container_ip
	local container_hostname
	local extra_docker_args=(
		-v ${HOME}/.signal/config:${container_home}/.config
		-v ${HOME}/.signal/cache:${container_home}/.cache
	)
	local application_args=(
		"$@"
	)

	docker_run
}
alias signal-beta=signal-messenger-beta
signal-messenger-beta(){
	local container_name="signal-messenger-beta"
	local container_home="/root"
	local image_name="${MY_DOCKER_REPO_PREFIX}/signal-messenger:beta"
	local use_host_video=true
	local use_host_audio=true
	local use_host_dbus=false
	local use_host_user=false
	local attach_tty=false
	local network="trusted"
	local extra_networks=()
	local container_ip
	local container_hostname
	local extra_docker_args=(
		-v ${HOME}/.signal/config:${container_home}/.config
		-v ${HOME}/.signal/cache:${container_home}/.cache
	)
	local application_args=(
		"$@"
	)

	docker_run
}
vivaldi(){
	relies_on pulseaudio
	local run_type=
	if [[ "$1" == "secure" ]]; then
		run_type="$1"
		shift
	fi

	local extra_vivaldi_args=( ${@} )
	local extra_docker_args=()
	local name_suffix=
	local args_hash=$(sha1sum <<<"${*}" | cut -c1-40)
	local display_ip=$(docker network inspect --format='{{range .IPAM.Config}}{{.Gateway}}{{end}}' ${network})

local attach_tty=false
	local network="trusted"
	local extra_networks=()
	case "${run_type}" in
		secure)
			relies_on pia-vpn
			name_suffix="-secure"
			network="container:pia-vpn"
			display_ip=$(docker network inspect --format='{{range .IPAM.Config}}{{.Gateway}}{{end}}' untrusted)

			extra_docker_args+=(
				--tmpfs "/home/vivaldi/.cache"
				--tmpfs "/home/vivaldi/.config"
				--tmpfs "/home/vivaldi/.pki"
			)
			extra_vivaldi_args+=(
				--incognito
				https://www.privateinternetaccess.com/
			)
			;;
		*)
			relies_on_networks ${network}
			extra_docker_args+=(
				-v ${HOME}/.vivaldi/cache:/home/vivaldi/.cache
				-v ${HOME}/.vivaldi/config:/home/vivaldi/.config
				-v ${HOME}/.vivaldi/pki:/home/vivaldi/.pki
				-v ${HOME}/Downloads:/home/vivaldi/Downloads
				-v ${HOME}/Pictures:/home/vivaldi/Pictures
				-v ${HOME}/Torrents:/home/vivaldi/Torrents
			)
			extra_vivaldi_args+=(
				-new-window
			)
			;;
	esac

	del_stopped vivaldi${name_suffix}-${args_hash}
	relies_on pulseaudio

	if [ ! -f ${HOME}/seccomp/chrome.json ]; then
		mkdir -p ${HOME}/seccomp
		wget https://raw.githubusercontent.com/jfrazelle/dotfiles/master/etc/docker/seccomp/chrome.json -O ${HOME}/seccomp/chrome.json
	fi

	docker run --rm -d \
		--network ${network} \
		--memory 4gb \
		--shm-size=2g \
		-h "$(hostname)" \
		-v /etc/localtime:/etc/localtime:ro \
		-e DISPLAY="${display_ip}${DISPLAY}" \
		-e GDK_SCALE \
		-e GDK_DPI_SCALE \
		-e PULSE_SERVER="pulseaudio" \
		--security-opt seccomp:${HOME}/seccomp/chrome.json \
		${extra_docker_args[@]} \
		--name vivaldi${name_suffix}-${args_hash} \
		${MY_DOCKER_REPO_PREFIX}/vivaldi \
			${extra_vivaldi_args[@]}
}
